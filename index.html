<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>词汇觉醒 - Vocabulary Awakening</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script src="data.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#4ade80',
            secondary: '#22c55e',
            accent: '#16a34a',
            light: '#ecfccb',
            dark: '#15803d'
          },
          fontFamily: {
            sans: ['Inter', 'system-ui', 'sans-serif'],
          },
        },
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .content-auto {
        content-visibility: auto;
      }
      .text-shadow {
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
      }
      .card-hover {
        transition: all 0.3s ease;
      }
      .card-hover:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px -5px rgba(0,0,0,0.1);
      }
    }
  </style>
  <style>
    /* 隐藏原生单选按钮 */
    input[type="radio"] {
      display: none;
    }
    
    /* 确保标签可以点击 */
    label {
      cursor: pointer;
    }
    
    /* 确保选项容器的样式正确 */
    #options-container {
      min-height: 150px;
    }
  </style>
</head>
<body class="bg-gradient-to-br from-light to-primary min-h-screen font-sans text-gray-800">
  <!-- 顶部导航栏 -->
  <header class="bg-white/80 backdrop-blur-md shadow-sm sticky top-0 z-50">
    <div class="container mx-auto px-4 py-3 flex justify-between items-center">
      <div class="flex items-center space-x-2">
        <i class="fa fa-book text-accent text-2xl"></i>
        <h1 class="text-xl font-bold text-accent">词汇觉醒</h1>
      </div>
      <div class="flex items-center space-x-4">
        <div class="flex items-center">
          <i class="fa fa-star text-yellow-500 mr-1"></i>
          <span id="score" class="font-semibold">0</span>
        </div>
        <div class="flex items-center">
          <i class="fa fa-tasks text-gray-600 mr-1"></i>
          <span id="progress-text" class="font-semibold">0%</span>
        </div>
        <button id="settings-btn" class="p-2 rounded-full hover:bg-gray-100">
          <i class="fa fa-cog text-gray-600"></i>
        </button>
      </div>
    </div>
  </header>

  <!-- 主内容区 -->
  <main class="container mx-auto px-4 py-6">
    <!-- 进度条 -->
    <div class="mb-6 bg-white/60 rounded-full h-4 overflow-hidden">
      <div id="progress-bar" class="bg-secondary h-full transition-all duration-500" style="width: 0%"></div>
    </div>

    <!-- 欢迎屏幕 -->
    <section id="welcome-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6">
      <div class="text-center py-8">
        <i class="fa fa-lightbulb-o text-5xl text-accent mb-4"></i>
        <h2 class="text-2xl font-bold text-accent mb-2">欢迎使用词汇觉醒</h2>
        <p class="text-gray-600 mb-6">通过多样化的练习方式，让词汇学习更高效、更有趣！</p>
        <div class="space-y-2 text-left max-w-md mx-auto mb-8">
          <div class="flex items-start">
            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
            <p>同一个单词以3个不同的例句出现3次才算掌握</p>
          </div>
          <div class="flex items-start">
            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
            <p>包含单句选择题和逻辑配对题</p>
          </div>
          <div class="flex items-start">
            <i class="fa fa-check-circle text-secondary mt-1 mr-2"></i>
            <p>积分系统、进度条、错题记录和复盘环节</p>
          </div>
        </div>
        
        <!-- 分组选择 -->
        <div class="max-w-md mx-auto mb-8">
          <h3 class="text-lg font-semibold text-gray-700 mb-4">选择练习分组</h3>
          <div class="grid grid-cols-2 gap-3" id="group-selection">
            <!-- 分组选项将在这里动态生成 -->
          </div>
        </div>
        
        <button id="start-btn" class="bg-secondary hover:bg-accent text-white font-bold py-3 px-8 rounded-full transition-all duration-300 transform hover:scale-105 shadow-md">
          开始学习
        </button>
      </div>
    </section>

    <!-- 题目屏幕 -->
    <section id="question-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <!-- 题目区域 -->
      <div class="mb-4">
        <h2 id="question-type" class="text-lg font-semibold text-gray-700 mb-2">单句选择题</h2>
        <p id="question-content" class="text-gray-800 mb-4">请选择与划线单词意思最接近的选项：</p>
        <div id="question-sentence" class="bg-light/70 p-4 rounded-lg mb-6 border-l-4 border-secondary">
          <!-- 例句将在这里动态插入 -->
        </div>
      </div>
      
      <!-- 选项区域 -->
      <div id="options-container" class="space-y-3 mb-6">
        <!-- 选项将在这里动态插入 -->
      </div>
      
      <!-- 控制按钮 -->
      <div class="flex justify-between mb-6" id="question-controls">
        <button id="prev-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-4 rounded-lg transition-all duration-300">
          <i class="fa fa-arrow-left mr-1"></i> 上一题
        </button>
        <button id="next-btn" class="bg-secondary hover:bg-accent text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
          下一题 <i class="fa fa-arrow-right ml-1"></i>
        </button>
      </div>
      
      <!-- 结果区域 (默认隐藏) -->
      <div id="result-section" class="bg-light/50 rounded-lg p-6 mb-6 hidden">
        <div class="text-center">
          <i id="result-icon" class="fa fa-check-circle text-4xl text-green-500 mb-4"></i>
          <h2 id="result-title" class="text-xl font-bold text-gray-800 mb-2">回答正确！</h2>
          <p id="result-message" class="text-gray-600 mb-4">太棒了，继续加油！</p>
          <div class="mb-4">
            <p class="text-gray-700 mb-1">本次得分：<span id="result-score" class="font-semibold text-accent">0</span></p>
            <p class="text-gray-700">累计得分：<span id="total-score" class="font-semibold text-accent">0</span></p>
          </div>
          <button id="continue-btn" class="bg-secondary hover:bg-accent text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
            继续
          </button>
        </div>
      </div>
    </section>

    <!-- 错题复盘屏幕 -->
    <section id="review-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-accent mb-4">错题复盘</h2>
        <p class="text-gray-600 mb-6">以下是您本次练习中的错题，点击查看详细解析：</p>
        <div id="wrong-questions" class="space-y-4">
          <!-- 错题将在这里动态插入 -->
        </div>
      </div>
      <div class="flex justify-center">
        <button id="restart-btn" class="bg-secondary hover:bg-accent text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
          重新开始
        </button>
      </div>
    </section>

    <!-- 完成屏幕 -->
    <section id="complete-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <div class="text-center py-8">
        <i class="fa fa-trophy text-5xl text-yellow-500 mb-4"></i>
        <h2 class="text-2xl font-bold text-accent mb-2">练习完成！</h2>
        <p class="text-gray-600 mb-6">恭喜您完成了本次词汇练习！</p>
        <div class="mb-8 space-y-2">
          <p class="text-gray-700">本次得分：<span id="complete-score" class="font-semibold text-accent">0</span></p>
          <p class="text-gray-700">累计得分：<span id="complete-total-score" class="font-semibold text-accent">0</span></p>
          <p class="text-gray-700">正确率：<span id="accuracy" class="font-semibold text-accent">0%</span></p>
          <p class="text-gray-700">掌握单词：<span id="mastered-words" class="font-semibold text-accent">0</span>个</p>
        </div>
        <div class="flex flex-col sm:flex-row justify-center gap-4">
          <button id="review-wrong-btn" class="bg-gray-200 hover:bg-gray-300 text-gray-700 font-medium py-2 px-6 rounded-lg transition-all duration-300">
            查看错题
          </button>
          <button id="complete-restart-btn" class="bg-secondary hover:bg-accent text-white font-bold py-2 px-6 rounded-lg transition-all duration-300">
            重新开始
          </button>
        </div>
      </div>
    </section>

    <!-- 单词本屏幕 -->
    <section id="wordbook-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-accent mb-4">单词本</h2>
        <div class="relative">
          <input type="text" id="word-search" placeholder="搜索单词..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
          <i class="fa fa-search absolute right-3 top-2.5 text-gray-400"></i>
        </div>
      </div>
      <div id="word-list" class="space-y-3 max-h-[60vh] overflow-y-auto pr-2">
        <!-- 单词列表将在这里动态生成 -->
      </div>
    </section>

    <!-- 统计屏幕 -->
    <section id="stats-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-accent mb-4">学习统计</h2>
      </div>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- 左侧统计卡片 -->
        <div class="space-y-4">
          <div class="bg-light/50 p-4 rounded-lg">
            <h3 class="text-sm text-gray-600 mb-1">总积分</h3>
            <p class="text-2xl font-bold text-accent" id="total-score-stats">0</p>
          </div>
          <div class="bg-light/50 p-4 rounded-lg">
            <h3 class="text-sm text-gray-600 mb-1">已掌握单词</h3>
            <p class="text-2xl font-bold text-accent" id="mastered-words-stats">0</p>
          </div>
          <div class="bg-light/50 p-4 rounded-lg">
            <h3 class="text-sm text-gray-600 mb-1">连胜天数</h3>
            <p class="text-2xl font-bold text-accent" id="streak-days">0</p>
          </div>
        </div>
        <!-- 右侧进度环 -->
        <div class="flex flex-col items-center justify-center">
          <div class="relative w-48 h-48">
            <!-- 环形进度条背景 -->
            <svg class="w-full h-full" viewBox="0 0 100 100">
              <circle cx="50" cy="50" r="45" fill="none" stroke="#e5e7eb" stroke-width="10"/>
              <!-- 环形进度条 -->
              <circle id="progress-ring" cx="50" cy="50" r="45" fill="none" stroke="#4ade80" stroke-width="10" stroke-linecap="round" transform="rotate(-90 50 50)" stroke-dasharray="283" stroke-dashoffset="283"/>
            </svg>
            <!-- 进度百分比 -->
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <p class="text-3xl font-bold text-accent" id="progress-percent">0%</p>
              <p class="text-sm text-gray-600">P1+P2 完成进度</p>
            </div>
          </div>
          <div class="mt-4 text-center">
            <p class="text-sm text-gray-600">继续努力，解锁更多词汇！</p>
          </div>
        </div>
      </div>
    </section>

    <!-- 我的屏幕 -->
    <section id="my-screen" class="bg-white/90 rounded-xl shadow-md p-6 mb-6 hidden">
      <div class="mb-6">
        <h2 class="text-xl font-bold text-accent mb-4">我的</h2>
      </div>
      <!-- 进度同步板块 -->
      <div class="bg-light/50 p-4 rounded-lg mb-6">
        <h3 class="text-lg font-semibold text-gray-700 mb-4">进度同步</h3>
        <div class="space-y-4">
          <!-- 生成同步码 -->
          <div>
            <button id="generate-sync-code-btn" class="w-full bg-secondary hover:bg-accent text-white font-bold py-2 px-4 rounded-lg transition-all duration-300">
              备份当前进度
            </button>
            <div id="sync-code-container" class="mt-3 hidden">
              <div class="flex justify-between items-center bg-white p-3 rounded-lg border">
                <span id="sync-code" class="font-mono text-sm"></span>
                <button id="copy-sync-code-btn" class="text-secondary hover:text-accent">
                  <i class="fa fa-copy"></i>
                </button>
              </div>
              <p class="text-xs text-gray-500 mt-2">同步码已生成，可用于在其他设备恢复进度</p>
            </div>
          </div>
          <!-- 导入同步码 -->
          <div>
            <div class="mb-2">
              <input type="text" id="import-sync-code" placeholder="输入同步码..." class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-secondary">
            </div>
            <button id="import-sync-code-btn" class="w-full bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-lg transition-all duration-300">
              恢复进度
            </button>
          </div>
          <!-- 重置进度 -->
          <div class="mt-4">
            <button id="reset-progress-btn" class="w-full bg-red-200 hover:bg-red-300 text-red-700 font-bold py-2 px-4 rounded-lg transition-all duration-300">
              重置所有进度
            </button>
          </div>
        </div>
      </div>
    </section>
  </main>

  <!-- 底部导航 -->
  <footer class="bg-white/80 backdrop-blur-md shadow-sm py-3">
    <div class="container mx-auto px-4">
      <div class="flex justify-around">
        <button class="flex flex-col items-center text-accent">
          <i class="fa fa-home text-lg"></i>
          <span class="text-xs mt-1">首页</span>
        </button>
        <button class="flex flex-col items-center text-gray-500">
          <i class="fa fa-list text-lg"></i>
          <span class="text-xs mt-1">单词本</span>
        </button>
        <button class="flex flex-col items-center text-gray-500">
          <i class="fa fa-bar-chart text-lg"></i>
          <span class="text-xs mt-1">统计</span>
        </button>
        <button class="flex flex-col items-center text-gray-500">
          <i class="fa fa-user text-lg"></i>
          <span class="text-xs mt-1">我的</span>
        </button>
      </div>
    </div>
  </footer>

  <script>
    // 应用状态管理
    const appState = {
      currentScreen: 'welcome',
      currentGroup: null,
      currentQuestion: 0,
      questionBank: [],
      correctAnswers: 0,
      totalQuestions: 0,
      score: 0,
      wordMastery: {},
      wrongQuestions: [],
      unlockedGroups: ['P1-01'],
      groupScores: {}
    };

    // DOM 元素引用
    const elements = {
      welcomeScreen: document.getElementById('welcome-screen'),
      questionScreen: document.getElementById('question-screen'),
      reviewScreen: document.getElementById('review-screen'),
      completeScreen: document.getElementById('complete-screen'),
      wordbookScreen: document.getElementById('wordbook-screen'),
      statsScreen: document.getElementById('stats-screen'),
      myScreen: document.getElementById('my-screen'),
      startBtn: document.getElementById('start-btn'),
      nextBtn: document.getElementById('next-btn'),
      prevBtn: document.getElementById('prev-btn'),
      continueBtn: document.getElementById('continue-btn'),
      restartBtn: document.getElementById('restart-btn'),
      reviewWrongBtn: document.getElementById('review-wrong-btn'),
      completeRestartBtn: document.getElementById('complete-restart-btn'),
      groupSelection: document.getElementById('group-selection'),
      questionType: document.getElementById('question-type'),
      questionContent: document.getElementById('question-content'),
      questionSentence: document.getElementById('question-sentence'),
      optionsContainer: document.getElementById('options-container'),
      resultSection: document.getElementById('result-section'),
      resultIcon: document.getElementById('result-icon'),
      resultTitle: document.getElementById('result-title'),
      resultMessage: document.getElementById('result-message'),
      resultScore: document.getElementById('result-score'),
      totalScore: document.getElementById('total-score'),
      score: document.getElementById('score'),
      progressBar: document.getElementById('progress-bar'),
      progressText: document.getElementById('progress-text'),
      completeScore: document.getElementById('complete-score'),
      completeTotalScore: document.getElementById('complete-total-score'),
      accuracy: document.getElementById('accuracy'),
      masteredWords: document.getElementById('mastered-words'),
      wrongQuestions: document.getElementById('wrong-questions'),
      wordList: document.getElementById('word-list'),
      wordSearch: document.getElementById('word-search'),
      totalScoreStats: document.getElementById('total-score-stats'),
      masteredWordsStats: document.getElementById('mastered-words-stats'),
      streakDays: document.getElementById('streak-days'),
      progressPercent: document.getElementById('progress-percent'),
      generateSyncCodeBtn: document.getElementById('generate-sync-code-btn'),
      syncCodeContainer: document.getElementById('sync-code-container'),
      syncCode: document.getElementById('sync-code'),
      copySyncCodeBtn: document.getElementById('copy-sync-code-btn'),
      importSyncCode: document.getElementById('import-sync-code'),
      importSyncCodeBtn: document.getElementById('import-sync-code-btn'),
      resetProgressBtn: document.getElementById('reset-progress-btn')
    };

    // 初始化应用
    function initApp() {
      try {
        // 从localStorage读取数据
        const savedWordMastery = localStorage.getItem('wordMastery');
        const savedScore = localStorage.getItem('totalScore');
        const savedUnlockedGroups = localStorage.getItem('unlockedGroups');
        const savedGroupScores = localStorage.getItem('groupScores');
        const savedStreakDays = localStorage.getItem('streakDays');
        const savedLastStudyDate = localStorage.getItem('lastStudyDate');
        
        console.log('开始初始化应用...');
        console.log('wordDatabase是否存在:', typeof wordDatabase !== 'undefined');
        
        // 初始化单词掌握度
        if (savedWordMastery) {
          appState.wordMastery = JSON.parse(savedWordMastery);
          console.log('从localStorage读取单词掌握度:', appState.wordMastery);
        } else {
          // 首次加载，初始化所有单词为0
          appState.wordMastery = {};
          if (typeof wordDatabase !== 'undefined') {
            Object.values(wordDatabase).forEach(group => {
              group.forEach(word => {
                appState.wordMastery[word.word] = 0;
              });
            });
            console.log('首次加载，初始化单词掌握度');
          } else {
            console.error('wordDatabase未定义，无法初始化单词掌握度');
          }
        }
        
        // 初始化总积分
        if (savedScore) {
          appState.score = parseInt(savedScore);
          console.log('从localStorage读取积分:', appState.score);
        } else {
          appState.score = 0;
        }
        
        // 直接解锁所有分组
        if (typeof wordDatabase !== 'undefined') {
          appState.unlockedGroups = Object.keys(wordDatabase);
          console.log('解锁所有分组:', appState.unlockedGroups);
          // 保存解锁状态
          localStorage.setItem('unlockedGroups', JSON.stringify(appState.unlockedGroups));
        } else {
          appState.unlockedGroups = ['P1-01'];
          console.error('wordDatabase未定义，使用默认分组');
        }
        
        // 初始化分组得分
        if (savedGroupScores) {
          appState.groupScores = JSON.parse(savedGroupScores);
          console.log('从localStorage读取分组得分:', appState.groupScores);
        } else {
          appState.groupScores = {};
        }
        
        // 初始化连胜天数
        appState.streakDays = savedStreakDays ? parseInt(savedStreakDays) : 0;
        console.log('从localStorage读取连胜天数:', appState.streakDays);
        
        // 更新连胜天数
        updateStreakDays(savedLastStudyDate);
        
        // 生成分组选择UI
        generateGroupSelection();
        
        // 绑定事件监听器
        bindEventListeners();
        
        // 更新UI显示
        updateScore();
        updateStats();
        
        console.log('应用初始化完成');
      } catch (error) {
        console.error('初始化应用失败:', error);
        alert('初始化应用失败，请刷新页面重试');
      }
    }

    // 更新连胜天数
    function updateStreakDays(lastStudyDate) {
      const today = new Date().toDateString();
      
      if (lastStudyDate && lastStudyDate === today) {
        // 今天已经学习过，不需要更新
        console.log('今天已经学习过，连胜天数保持不变:', appState.streakDays);
      } else if (lastStudyDate) {
        const lastDate = new Date(lastStudyDate);
        const todayDate = new Date(today);
        const diffTime = Math.abs(todayDate - lastDate);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays === 1) {
          // 连续学习
          appState.streakDays += 1;
          console.log('连续学习，连胜天数更新为:', appState.streakDays);
        } else if (diffDays > 1) {
          // 中断学习
          appState.streakDays = 1;
          console.log('中断学习，连胜天数重置为:', appState.streakDays);
        }
      } else {
        // 首次学习
        appState.streakDays = 1;
        console.log('首次学习，连胜天数设置为:', appState.streakDays);
      }
      
      // 更新最后学习日期
      localStorage.setItem('lastStudyDate', today);
      localStorage.setItem('streakDays', appState.streakDays.toString());
      console.log('更新最后学习日期:', today);
    }

    // 生成分组选择UI
    function generateGroupSelection() {
      elements.groupSelection.innerHTML = '';
      
      Object.keys(wordDatabase).forEach(groupKey => {
        const isUnlocked = appState.unlockedGroups.includes(groupKey);
        const groupWords = wordDatabase[groupKey];
        const groupScore = appState.groupScores[groupKey] || 0;
        const masteredCount = groupWords.filter(word => appState.wordMastery[word.word] === 3).length;
        const masteryRate = Math.round((masteredCount / groupWords.length) * 100);
        
        const groupButton = document.createElement('div');
        groupButton.className = `card-hover p-4 rounded-lg border cursor-pointer transition-all duration-300 ${isUnlocked ? 'bg-white' : 'bg-gray-100 border-gray-300'}`;
        
        if (!isUnlocked) {
          groupButton.classList.add('opacity-50');
          groupButton.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="font-semibold">${groupKey}</span>
              <i class="fa fa-lock text-gray-400"></i>
            </div>
            <p class="text-sm text-gray-500 mt-1">未解锁</p>
          `;
        } else {
          groupButton.innerHTML = `
            <div class="flex justify-between items-center">
              <span class="font-semibold">${groupKey}</span>
              <span class="text-sm text-gray-600">${groupWords.length}词</span>
            </div>
            <div class="flex justify-between items-center mt-1">
              <span class="text-sm text-gray-500">掌握 ${masteryRate}%</span>
              <span class="text-sm text-accent">${groupScore} 分</span>
            </div>
          `;
          
          groupButton.addEventListener('click', () => {
            appState.currentGroup = groupKey;
            console.log('选择分组:', groupKey);
            generateQuestionBank();
            showScreen('question-screen');
            loadQuestion(0);
          });
        }
        
        elements.groupSelection.appendChild(groupButton);
      });
    }

    // 生成题目库
    function generateQuestionBank() {
      appState.questionBank = [];
      const groupWords = wordDatabase[appState.currentGroup];
      
      if (!groupWords) {
        console.error('分组单词不存在:', appState.currentGroup);
        return;
      }
      
      // 为每个单词生成多个题目（每个单词最多生成3个题目，使用不同的例句）
      groupWords.forEach(word => {
        // 生成单句选择题
        if (word.examples && word.examples.length > 0) {
          // 为每个例句生成一个题目，最多生成3个
          const examplesToUse = word.examples.slice(0, 3);
          examplesToUse.forEach(example => {
            // 生成干扰选项
            const distractors = generateDistractors(word.meaning, groupWords);
            
            // 组合选项
            const options = [word.meaning, ...distractors];
            shuffleArray(options);
            
            // 找到正确答案的索引
            const correctIndex = options.indexOf(word.meaning);
            
            // 创建题目对象
            const question = {
              type: 'single-choice',
              word: word.word,
              meaning: word.meaning,
              partOfSpeech: word.partOfSpeech,
              example: example,
              options: options,
              correctAnswer: correctIndex
            };
            
            appState.questionBank.push(question);
          });
        }
      });
      
      // 打乱题目顺序
      shuffleArray(appState.questionBank);
      
      // 限制题目数量为45题（每个单词最多3个题目，15个单词）
      if (appState.questionBank.length > 45) {
        appState.questionBank = appState.questionBank.slice(0, 45);
      }
      
      appState.totalQuestions = appState.questionBank.length;
      appState.currentQuestion = 0;
      appState.correctAnswers = 0;
      appState.wrongQuestions = [];
      
      console.log('生成题目库:', appState.questionBank);
      console.log('题目数量:', appState.totalQuestions);
    }

    // 生成干扰选项
    function generateDistractors(correctMeaning, groupWords) {
      const distractors = [];
      const allMeanings = [...new Set(groupWords.map(word => word.meaning))];
      
      // 随机选择3个不同的干扰选项
      while (distractors.length < 3) {
        const randomMeaning = allMeanings[Math.floor(Math.random() * allMeanings.length)];
        if (randomMeaning !== correctMeaning && !distractors.includes(randomMeaning)) {
          distractors.push(randomMeaning);
        }
      }
      
      return distractors;
    }

    // 打乱数组
    function shuffleArray(array) {
      for (let i = array.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [array[i], array[j]] = [array[j], array[i]];
      }
    }

    // 加载题目
    function loadQuestion(index) {
      if (!appState.questionBank || appState.questionBank.length === 0 || index < 0 || index >= appState.questionBank.length) {
        console.error('题目库为空或索引无效:', index);
        return;
      }
      
      appState.currentQuestion = index;
      const question = appState.questionBank[index];
      
      // 更新题目类型和内容
      elements.questionType.textContent = '单句选择题';
      elements.questionContent.textContent = '请选择与划线单词意思最接近的选项：';
      
      // 处理例句，添加下划线
      // 创建正则表达式，使用全局匹配和不区分大小写
      const wordRegex = new RegExp(`\\b${question.word}\\b`, 'gi');
      // 使用回调函数来保持原单词的大小写
      const sentenceWithUnderline = question.example.replace(wordRegex, (match) => {
        return `<span class="font-semibold underline">${match}</span>`;
      });
      elements.questionSentence.innerHTML = sentenceWithUnderline;
      
      // 生成选项
      elements.optionsContainer.innerHTML = '';
      question.options.forEach((option, i) => {
        const optionDiv = document.createElement('div');
        optionDiv.className = 'option-item';
        
        const radioId = `option-${i}`;
        const radioInput = document.createElement('input');
        radioInput.type = 'radio';
        radioInput.id = radioId;
        radioInput.name = 'option';
        radioInput.value = i;
        
        const label = document.createElement('label');
        label.htmlFor = radioId;
        label.className = 'flex items-center p-3 rounded-lg border hover:bg-light/50 transition-all duration-200 w-full';
        
        const radioCircle = document.createElement('div');
        radioCircle.className = 'w-5 h-5 rounded-full border-2 border-gray-300 flex items-center justify-center mr-3 transition-all duration-200';
        
        const radioInner = document.createElement('div');
        radioInner.className = 'w-3 h-3 rounded-full bg-secondary opacity-0 transition-all duration-200';
        
        radioCircle.appendChild(radioInner);
        label.appendChild(radioCircle);
        label.appendChild(document.createTextNode(option));
        
        optionDiv.appendChild(radioInput);
        optionDiv.appendChild(label);
        elements.optionsContainer.appendChild(optionDiv);
        
        // 绑定选项点击事件
        radioInput.addEventListener('change', () => {
          // 移除所有选项的选中状态
          document.querySelectorAll('.option-item label').forEach(l => {
            l.classList.remove('border-secondary', 'bg-light/50');
            l.querySelector('div div').classList.add('opacity-0');
          });
          
          // 设置当前选项为选中状态
          label.classList.add('border-secondary', 'bg-light/50');
          radioInner.classList.remove('opacity-0');
          
          // 处理答案
          handleAnswer(i, question);
        });
      });
      
      // 更新进度条
      updateProgress();
      
      // 隐藏结果区域
      elements.resultSection.classList.add('hidden');
      elements.questionControls.classList.remove('hidden');
    }

    // 处理答案
    function handleAnswer(selectedIndex, question) {
      const isCorrect = selectedIndex === question.correctAnswer;
      
      if (isCorrect) {
        appState.correctAnswers++;
        
        // 更新单词掌握度
        const currentMastery = appState.wordMastery[question.word] || 0;
        if (currentMastery < 3) {
          appState.wordMastery[question.word] = currentMastery + 1;
        }
        
        // 计算得分（正确答案得10分）
        const pointsEarned = 10;
        appState.score += pointsEarned;
        
        // 更新分组得分
        if (!appState.groupScores[appState.currentGroup]) {
          appState.groupScores[appState.currentGroup] = 0;
        }
        appState.groupScores[appState.currentGroup] += pointsEarned;
        
        // 保存数据到localStorage
        saveDataToLocalStorage();
        
        // 更新分数显示
        updateScore();
        
        // 自动跳转下一题，不显示结果区域
        setTimeout(() => {
          if (appState.currentQuestion < appState.totalQuestions - 1) {
            loadQuestion(appState.currentQuestion + 1);
          } else {
            // 所有题目完成
            completePractice();
          }
        }, 800);
      } else {
        // 显示错误结果
        elements.resultIcon.className = 'fa fa-times-circle text-4xl text-red-500 mb-4';
        elements.resultTitle.textContent = '回答错误！';
        elements.resultMessage.textContent = `正确答案是：${question.meaning}`;
        elements.resultScore.textContent = 0;
        elements.totalScore.textContent = appState.score;
        
        // 添加到错题记录
        appState.wrongQuestions.push(question);
        
        // 显示结果区域
        elements.resultSection.classList.remove('hidden');
        elements.questionControls.classList.add('hidden');
        
        // 错误答案不自动跳转，等待手动点击
        elements.continueBtn.addEventListener('click', function handleContinue() {
          if (appState.currentQuestion < appState.totalQuestions - 1) {
            loadQuestion(appState.currentQuestion + 1);
          } else {
            // 所有题目完成
            completePractice();
          }
          // 移除事件监听器，避免重复绑定
          elements.continueBtn.removeEventListener('click', handleContinue);
        }, { once: true });
      }
    }

    // 完成练习
    function completePractice() {
      // 检查解锁状态
      checkUnlockStatus();
      
      // 更新统计数据
      updateStats();
      
      // 显示完成屏幕
      showScreen('complete-screen');
      
      // 更新完成屏幕数据
      const accuracy = Math.round((appState.correctAnswers / appState.totalQuestions) * 100);
      const masteredCount = Object.values(appState.wordMastery).filter(mastery => mastery === 3).length;
      
      elements.completeScore.textContent = appState.groupScores[appState.currentGroup] || 0;
      elements.completeTotalScore.textContent = appState.score;
      elements.accuracy.textContent = `${accuracy}%`;
      elements.masteredWords.textContent = masteredCount;
    }

    // 检查解锁状态
    function checkUnlockStatus() {
      const currentGroupKey = appState.currentGroup;
      const groupWords = wordDatabase[currentGroupKey];
      const masteredCount = groupWords.filter(word => appState.wordMastery[word.word] === 3).length;
      const masteryRate = masteredCount / groupWords.length;
      
      console.log(`分组 ${currentGroupKey} 掌握率: ${Math.round(masteryRate * 100)}%`);
      
      // 检查是否达到90%掌握率
      if (masteryRate >= 0.9) {
        // 获取当前分组的索引
        const groupKeys = Object.keys(wordDatabase);
        const currentIndex = groupKeys.indexOf(currentGroupKey);
        
        // 检查是否有下一组
        if (currentIndex < groupKeys.length - 1) {
          const nextGroupKey = groupKeys[currentIndex + 1];
          
          // 检查下一组是否已解锁
          if (!appState.unlockedGroups.includes(nextGroupKey)) {
            appState.unlockedGroups.push(nextGroupKey);
            console.log(`解锁新分组: ${nextGroupKey}`);
            
            // 保存解锁状态
            localStorage.setItem('unlockedGroups', JSON.stringify(appState.unlockedGroups));
            
            // 更新分组选择UI
            generateGroupSelection();
          }
        }
      }
    }

    // 更新进度条
    function updateProgress() {
      const progress = Math.round(((appState.currentQuestion + 1) / appState.totalQuestions) * 100);
      elements.progressBar.style.width = `${progress}%`;
      elements.progressText.textContent = `${progress}%`;
    }

    // 更新分数显示
    function updateScore() {
      elements.score.textContent = appState.score;
    }

    // 更新统计数据
    function updateStats() {
      // 更新统计屏幕数据
      elements.totalScoreStats.textContent = appState.score;
      
      const masteredCount = Object.values(appState.wordMastery).filter(mastery => mastery === 3).length;
      elements.masteredWordsStats.textContent = masteredCount;
      elements.streakDays.textContent = appState.streakDays;
      
      // 计算P1+P2的完成进度
      const p1p2Groups = Object.keys(wordDatabase).filter(key => key.startsWith('P1') || key.startsWith('P2'));
      let totalP1P2Words = 0;
      let masteredP1P2Words = 0;
      
      p1p2Groups.forEach(groupKey => {
        const groupWords = wordDatabase[groupKey];
        totalP1P2Words += groupWords.length;
        masteredP1P2Words += groupWords.filter(word => appState.wordMastery[word.word] === 3).length;
      });
      
      const p1p2Progress = Math.round((masteredP1P2Words / totalP1P2Words) * 100);
      elements.progressPercent.textContent = `${p1p2Progress}%`;
      
      // 更新环形进度条
      const circumference = 2 * Math.PI * 45;
      const offset = circumference - (p1p2Progress / 100) * circumference;
      document.getElementById('progress-ring').style.strokeDashoffset = offset;
    }

    // 保存数据到localStorage
    function saveDataToLocalStorage() {
      try {
        localStorage.setItem('wordMastery', JSON.stringify(appState.wordMastery));
        localStorage.setItem('totalScore', appState.score.toString());
        localStorage.setItem('unlockedGroups', JSON.stringify(appState.unlockedGroups));
        localStorage.setItem('groupScores', JSON.stringify(appState.groupScores));
        console.log('数据已保存到localStorage');
      } catch (error) {
        console.error('保存数据到localStorage失败:', error);
        alert('保存进度失败，请检查浏览器存储权限');
      }
    }

    // 显示指定屏幕
    function showScreen(screenId) {
      // 隐藏所有屏幕
      ['welcome', 'question', 'review', 'complete', 'wordbook', 'stats', 'my'].forEach(screen => {
        document.getElementById(`${screen}-screen`).classList.add('hidden');
      });
      
      // 移除可能的后缀，确保正确的屏幕ID
      const cleanScreenId = screenId.replace('-screen', '');
      
      // 显示指定屏幕
      document.getElementById(`${cleanScreenId}-screen`).classList.remove('hidden');
      appState.currentScreen = cleanScreenId;
      
      // 如果显示单词本，加载单词列表
      if (cleanScreenId === 'wordbook') {
        loadWordbook();
      }
      
      // 如果显示统计，更新统计数据
      if (cleanScreenId === 'stats') {
        updateStats();
      }
    }

    // 加载单词本
    function loadWordbook() {
      const wordSearch = elements.wordSearch.value.toLowerCase();
      elements.wordList.innerHTML = '';
      
      // 按单词库顺序分组显示
      Object.keys(wordDatabase).forEach(groupKey => {
        const groupWords = wordDatabase[groupKey];
        
        // 搜索过滤
        const filteredGroupWords = groupWords.filter(word => 
          word.word.toLowerCase().includes(wordSearch) || 
          word.meaning.toLowerCase().includes(wordSearch)
        );
        
        // 如果该分组没有匹配的单词，跳过
        if (filteredGroupWords.length === 0) {
          return;
        }
        
        // 创建分组标题
        const groupTitle = document.createElement('div');
        groupTitle.className = 'mt-4 mb-2';
        groupTitle.innerHTML = `<h3 class="font-semibold text-accent">${groupKey}</h3>`;
        elements.wordList.appendChild(groupTitle);
        
        // 生成该分组的单词列表
        filteredGroupWords.forEach(word => {
          const masteryLevel = appState.wordMastery[word.word] || 0;
          const masteryText = ['未学习', '生疏', '熟悉', '掌握'][masteryLevel];
          const masteryClass = ['text-gray-400', 'text-yellow-500', 'text-blue-500', 'text-green-500'][masteryLevel];
          
          const wordItem = document.createElement('div');
          wordItem.className = 'p-3 rounded-lg border hover:bg-light/50 transition-all duration-200';
          wordItem.innerHTML = `
            <div class="flex justify-between items-start">
              <div>
                <h3 class="font-semibold">${word.word}</h3>
                <p class="text-sm text-gray-600">${word.meaning}</p>
                <p class="text-xs text-gray-500 mt-1">${word.partOfSpeech}</p>
              </div>
              <span class="text-sm ${masteryClass}">${masteryText}</span>
            </div>
            ${word.examples && word.examples.length > 0 ? `<p class="text-xs text-gray-500 mt-2 italic">${word.examples[0]}</p>` : ''}
          `;
          
          elements.wordList.appendChild(wordItem);
        });
      });
    }

    // 绑定事件监听器
    function bindEventListeners() {
      // 开始按钮
      elements.startBtn.addEventListener('click', () => {
        if (!appState.currentGroup) {
          alert('请先选择一个分组');
          return;
        }
        generateQuestionBank();
        showScreen('question');
        loadQuestion(0);
      });
      
      // 下一题按钮
      elements.nextBtn.addEventListener('click', () => {
        if (appState.currentQuestion < appState.totalQuestions - 1) {
          loadQuestion(appState.currentQuestion + 1);
        } else {
          // 所有题目完成
          completePractice();
        }
      });
      
      // 上一题按钮
      elements.prevBtn.addEventListener('click', () => {
        if (appState.currentQuestion > 0) {
          loadQuestion(appState.currentQuestion - 1);
        }
      });
      
      // 继续按钮
      elements.continueBtn.addEventListener('click', () => {
        if (appState.currentQuestion < appState.totalQuestions - 1) {
          loadQuestion(appState.currentQuestion + 1);
        } else {
          // 所有题目完成
          completePractice();
        }
      });
      
      // 重新开始按钮
      elements.restartBtn.addEventListener('click', () => {
        showScreen('welcome');
      });
      
      // 查看错题按钮
      elements.reviewWrongBtn.addEventListener('click', () => {
        showScreen('review');
        displayWrongQuestions();
      });
      
      // 完成屏幕重新开始按钮
      elements.completeRestartBtn.addEventListener('click', () => {
        showScreen('welcome');
      });
      
      // 单词搜索
      elements.wordSearch.addEventListener('input', loadWordbook);
      
      // 底部导航按钮
      const navButtons = document.querySelectorAll('footer button');
      navButtons.forEach((button, index) => {
        const screens = ['welcome', 'wordbook', 'stats', 'my'];
        button.addEventListener('click', () => {
          // 更新导航按钮样式
          navButtons.forEach(btn => {
            btn.classList.remove('text-accent');
            btn.classList.add('text-gray-500');
          });
          button.classList.remove('text-gray-500');
          button.classList.add('text-accent');
          
          // 显示对应屏幕
          showScreen(screens[index]);
        });
      });
      
      // 生成同步码按钮
      elements.generateSyncCodeBtn.addEventListener('click', generateSyncCode);
      
      // 复制同步码按钮
      elements.copySyncCodeBtn.addEventListener('click', copySyncCode);
      
      // 导入同步码按钮
      elements.importSyncCodeBtn.addEventListener('click', importSyncCode);
      
      // 重置进度按钮
      elements.resetProgressBtn.addEventListener('click', resetProgress);
    }
    
    // 重置所有进度
    function resetProgress() {
      if (confirm('确定要重置所有进度吗？此操作不可恢复！')) {
        try {
          // 重置应用状态
          appState.wordMastery = {};
          appState.score = 0;
          appState.unlockedGroups = ['P1-01'];
          appState.groupScores = {};
          appState.streakDays = 0;
          
          // 初始化单词掌握度
          if (typeof wordDatabase !== 'undefined') {
            Object.values(wordDatabase).forEach(group => {
              group.forEach(word => {
                appState.wordMastery[word.word] = 0;
              });
            });
          }
          
          // 清除localStorage
          localStorage.removeItem('wordMastery');
          localStorage.removeItem('totalScore');
          localStorage.removeItem('unlockedGroups');
          localStorage.removeItem('groupScores');
          localStorage.removeItem('streakDays');
          localStorage.removeItem('lastStudyDate');
          
          // 保存新的初始状态
          saveDataToLocalStorage();
          localStorage.setItem('lastStudyDate', new Date().toDateString());
          
          // 更新UI
          updateScore();
          generateGroupSelection();
          updateStats();
          
          alert('所有进度已重置');
          console.log('重置所有进度');
        } catch (error) {
          console.error('重置进度失败:', error);
          alert('重置进度失败，请重试');
        }
      }
    }

    // 生成错题显示
    function displayWrongQuestions() {
      elements.wrongQuestions.innerHTML = '';
      
      if (appState.wrongQuestions.length === 0) {
        elements.wrongQuestions.innerHTML = '<p class="text-center text-gray-500 py-4">本次练习没有错题</p>';
        return;
      }
      
      appState.wrongQuestions.forEach((question, index) => {
        const wrongItem = document.createElement('div');
        wrongItem.className = 'p-4 rounded-lg border mb-3 hover:bg-light/50 transition-all duration-200';
        
        const sentenceWithUnderline = question.example.replace(question.word, `<span class="font-semibold underline">${question.word}</span>`);
        
        wrongItem.innerHTML = `
          <div class="mb-2">
            <span class="text-sm text-gray-500">第 ${index + 1} 题</span>
          </div>
          <p class="mb-3">${sentenceWithUnderline}</p>
          <div class="flex justify-between items-center">
            <div>
              <p class="text-sm font-semibold">正确答案：${question.meaning}</p>
            </div>
            <button class="text-sm text-secondary hover:text-accent">查看解析</button>
          </div>
        `;
        
        elements.wrongQuestions.appendChild(wrongItem);
      });
    }

    // 生成同步码
    function generateSyncCode() {
      // 准备同步数据
      const syncData = {
        wordMastery: appState.wordMastery,
        score: appState.score,
        unlockedGroups: appState.unlockedGroups,
        groupScores: appState.groupScores,
        streakDays: appState.streakDays,
        lastStudyDate: new Date().toDateString()
      };
      
      // 转换为JSON字符串
      const jsonString = JSON.stringify(syncData);
      
      // 使用Base64编码
      try {
        const syncCode = btoa(unescape(encodeURIComponent(jsonString)));
        elements.syncCode.textContent = syncCode;
        elements.syncCodeContainer.classList.remove('hidden');
        console.log('生成同步码:', syncCode);
      } catch (error) {
        console.error('生成同步码失败:', error);
        alert('生成同步码失败，请重试');
      }
    }

    // 复制同步码
    function copySyncCode() {
      const syncCode = elements.syncCode.textContent;
      navigator.clipboard.writeText(syncCode).then(() => {
        alert('同步码已复制到剪贴板');
      }).catch(err => {
        console.error('复制失败:', err);
        alert('复制失败，请手动复制');
      });
    }

    // 导入同步码
    function importSyncCode() {
      const syncCode = elements.importSyncCode.value.trim();
      
      if (!syncCode) {
        alert('请输入同步码');
        return;
      }
      
      try {
        // 使用Base64解码
        const jsonString = decodeURIComponent(escape(atob(syncCode)));
        const syncData = JSON.parse(jsonString);
        
        // 验证数据结构
        if (syncData.wordMastery && typeof syncData.score === 'number') {
          // 导入数据
          appState.wordMastery = syncData.wordMastery;
          appState.score = syncData.score;
          appState.unlockedGroups = syncData.unlockedGroups || ['P1-01'];
          appState.groupScores = syncData.groupScores || {};
          appState.streakDays = syncData.streakDays || 0;
          
          // 保存到localStorage
          saveDataToLocalStorage();
          localStorage.setItem('lastStudyDate', syncData.lastStudyDate || new Date().toDateString());
          
          // 更新UI
          updateScore();
          generateGroupSelection();
          
          alert('进度导入成功');
          elements.importSyncCode.value = '';
          console.log('导入同步数据:', syncData);
        } else {
          alert('同步码无效，请检查输入');
        }
      } catch (error) {
        console.error('导入同步码失败:', error);
        alert('同步码无效，请检查输入');
      }
    }

    // 保存数据到localStorage
    function saveDataToLocalStorage() {
      localStorage.setItem('wordMastery', JSON.stringify(appState.wordMastery));
      localStorage.setItem('totalScore', appState.score.toString());
      localStorage.setItem('unlockedGroups', JSON.stringify(appState.unlockedGroups));
      localStorage.setItem('groupScores', JSON.stringify(appState.groupScores));
      console.log('数据已保存到localStorage');
    }

    // 初始化应用
    window.addEventListener('DOMContentLoaded', initApp);
  </script>
</body>
</html>